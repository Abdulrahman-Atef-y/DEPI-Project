@model Hotel_Management_System.Models.DTOs.BookingDTO
@{
    ViewData["Title"] = "حجز الغرفة";
}

<link rel="stylesheet" href="~/css/admin-roomtype.css" />

<section class="booking-section" style="display:flex; flex-wrap:wrap; justify-content:space-between; gap:20px; padding:50px; background:#f9f9f9; font-family:Arial, sans-serif; direction:rtl; text-align:right; margin-top:60px;">

    <!-- Guest Information Form -->
    <div class="guest-info" style="flex:1; min-width:300px; background:white; padding:30px; border-radius:10px; box-shadow:0 2px 10px rgba(0,0,0,0.1);">
        <h2 style="color:#004080; margin-bottom:20px;">معلومات الضيف</h2>

        <form asp-controller="Booking" asp-action="Create" method="post">
            @Html.AntiForgeryToken()
            <div asp-validation-summary="ModelOnly" class="text-danger"></div>

            <input type="hidden" asp-for="RoomTypeId" />
            <input type="hidden" asp-for="PricePerNight" />
            <input type="hidden" asp-for="RoomTypeName" />
            <input type="hidden" asp-for="Occupancy" />

            <!-- Email & Phone -->
            <label>البريد الإلكتروني *</label>
            <input asp-for="Email" class="form-control" readonly  />

            <label>رقم الهاتف *</label>
            <input asp-for="phonenumber" type="tel" placeholder="أدخل رقم الهاتف" class="form-control" required />

            <!-- Number of Guests -->
            <h3 style="margin-top:30px; color:#004080;">عدد الضيوف</h3>
            <label>اختر عدد الضيوف *</label>
            <select asp-for="NumberOfGuests" id="guestCount" required class="form-control">
                <option value="">اختر</option>
                @for (int i = 1; i <= Model.Occupancy; i++)
                {
                    <option value="@i">@i</option>
                }
            </select>

            <!-- Dynamic Guest Fields -->
            <div id="guestFieldsContainer"></div>

            <!-- Booking Details -->
            <h3 style="margin-top:30px; color:#004080;">تفاصيل الحجز</h3>

            <label>تاريخ الوصول *</label>
            <input asp-for="CheckInDate" type="date" id="checkin" class="form-control" />
            <span asp-validation-for="CheckInDate" class="text-danger"></span>

            <label>تاريخ المغادرة *</label>
            <input asp-for="CheckOutDate" type="date" id="checkout" class="form-control" />
            <span asp-validation-for="CheckOutDate" class="text-danger"></span>

            <button type="submit" class="btn btn-primary" style="background:#004080; color:white; padding:12px 20px; border:none; border-radius:5px; cursor:pointer; width:100%; margin-top:20px;">
                إتمام الحجز
            </button>
        </form>
    </div>

    <!-- Booking Summary -->
    <div class="booking-summary" style="flex:0.4; min-width:300px; background:white; padding:30px; border-radius:12px; box-shadow:0 4px 15px rgba(0,0,0,0.08); height:fit-content;">

        <h2 style="color:#004080; margin-bottom:25px; font-size:22px; text-align:right;">تفاصيل الحجز</h2>

        <div style="background:#f1f6ff; padding:15px; border-radius:10px; margin-bottom:20px;">
            <p style="margin:0; font-size:18px;">
                <strong>@Model.RoomTypeName</strong>
            </p>
        </div>

        <div style="margin-bottom:15px;">
            <div style="display:flex; justify-content:space-between; margin:10px 0;">
                <span>السعر لليلة:</span>
                <strong>@Model.PricePerNight $</strong>
            </div>

            <div style="display:flex; justify-content:space-between; margin:10px 0;">
                <span>عدد الليالي:</span>
                <strong id="nights">0</strong>
            </div>

            <div style="display:flex; justify-content:space-between; margin:10px 0;">
                <span>الإجمالي قبل الضريبة:</span>
                <strong id="subtotal">$0.00</strong>
            </div>

            <div style="display:flex; justify-content:space-between; margin:10px 0;">
                <span>الضريبة (5%):</span>
                <strong id="tax">$0.00</strong>
            </div>

            <hr style="margin:20px 0;">

            <div style="display:flex; justify-content:space-between; font-size:20px; color:#004080; font-weight:bold;">
                <span>المجموع الكلي:</span>
                <span id="total">$0.00</span>
            </div>
        </div>

    </div>

</section>

<!-- Scripts -->
<script>
    // Dynamic Guest Fields
    document.getElementById("guestCount").addEventListener("change", function () {
        const count = parseInt(this.value);
        const container = document.getElementById("guestFieldsContainer");
        container.innerHTML = "";

        for (let i = 0; i < count; i++) {
            const html = `
                <div style="background:#f1f1f1; padding:15px; border-radius:10px; margin-top:20px;">
                    <h4 style="color:#004080;">الضيف رقم ${i + 1}</h4>

                    <label>الاسم الأول *</label>
                    <input type="text" name="BookingGuests[${i}].FirstName" placeholder="الاسم الأول" class="form-control" required />

                    <label>اسم العائلة *</label>
                    <input type="text" name="BookingGuests[${i}].LastName" placeholder="اسم العائلة" class="form-control" required />

                    <label>الرقم القومي / جواز السفر *</label>
                    <input type="text" name="BookingGuests[${i}].SSN" placeholder="الرقم القومي أو جواز السفر" class="form-control" required />
                </div>
            `;
            container.insertAdjacentHTML("beforeend", html);
        }
    });

    // Date & Price Summary
    document.addEventListener('DOMContentLoaded', function () {
        const today = new Date().toISOString().split("T")[0];
        const checkin = document.getElementById("checkin");
        const checkout = document.getElementById("checkout");
        const nightsField = document.getElementById("nights");
        const subtotalField = document.getElementById("subtotal");
        const taxField = document.getElementById("tax");
        const totalField = document.getElementById("total");
        const pricePerNight = @System.Text.Json.JsonSerializer.Serialize(Model.PricePerNight);

        if (checkin) checkin.setAttribute("min", today);
        if (checkout) checkout.setAttribute("min", today);

        if (checkin) checkin.addEventListener("change", function () {
            if (checkout) {
                checkout.value = "";
                checkout.setAttribute("min", this.value);
            }
            resetSummary();
        });

        if (checkout) checkout.addEventListener("change", function () {
            if (checkin && checkin.value && checkout.value < checkin.value) {
                alert("لا يمكن أن يكون تاريخ المغادرة قبل تاريخ الوصول.");
                this.value = "";
                resetSummary();
                return;
            }
            calculateNights();
        });

        function calculateNights() {
            if (!checkin || !checkout || !checkin.value || !checkout.value) return;
            const inDate = new Date(checkin.value);
            const outDate = new Date(checkout.value);
            const nights = (outDate - inDate) / (1000 * 60 * 60 * 24);

            if (nights < 1) {
                alert("يجب أن تكون مدة الإقامة ليلة واحدة على الأقل.");
                checkout.value = "";
                resetSummary();
                return;
            }

            nightsField.textContent = nights;
            const subtotal = nights * pricePerNight;
            const tax = subtotal * 0.05;
            const total = subtotal + tax;

            subtotalField.textContent = `$${subtotal.toFixed(2)}`;
            taxField.textContent = `$${tax.toFixed(2)}`;
            totalField.textContent = `$${total.toFixed(2)}`;
        }

        function resetSummary() {
            nightsField.textContent = "0";
            subtotalField.textContent = "$0.00";
            taxField.textContent = "$0.00";
            totalField.textContent = "$0.00";
        }
    });
</script>
